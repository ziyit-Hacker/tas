<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>申请修改密码——只因科技(中国)</title>
    <link rel="icon" href="../assets/ziyit.png" type="image/x-icon">
    <script src="../assets/f12check.js"></script>
    <script src="../assets/blacklist.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @media (max-width: 768px) {
            div[style*="max-width: 500px"] {
                width: 90%;
                padding: 15px;
            }

            input,
            select,
            button {
                width: 90% !important;
                font-size: 16px;
            }

            h1 {
                font-size: 20px !important;
            }
        }
    </style>
    <style>
        nav {
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }

        .product-grid {
            display: flex;
            flex-wrap: wrap;
        }

        .product {
            margin: 10px;
        }

        .brg {
            text-align: center;
        }


        a {
            text-decoration: none;
            color: forestgreen;
        }

        a:hover {
            text-decoration: underline overline;
            color: chartreuse;
        }

        a {
            text-decoration: none;
            color: #000000;
        }

        #previous:active {
            cursor: wait;
        }

        .brg {
            cursor: crosshair;
        }

        .bt {
            cursor: default;
        }

        #Navigation {
            width: 650px;
            height: 134px;
            background: url(ziyit_miv.png);
            margin: 10px auto;
        }

        input {
            padding: 12px 15px;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            background-color: #fff;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 280px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);
            color: #323130;
        }

        input:hover {
            border-color: #8a8886;
        }

        input:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .bt {
            font-weight: 600;
            color: #323130;
            font-size: 14px;
            margin-bottom: 4px;
            display: inline-block;
        }

        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #106ebe;
        }

        button:active {
            background-color: #005a9e;
        }

        * {
            cursor: default !important;
        }
    </style>
</head>

<body background="../assets/bgl.jpg" style=" background-repeat:no-repeat ;
        background-size:100% 100%;
        background-attachment: fixed;">
    <div
        style="max-width: 500px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h1 id="up" class="bt" style="font-size: 28px; margin-bottom: 20px;">申请修改密码</h1>

        <a href="javascript:history.back()" id="upback" style="color: #0078d4; text-decoration: none;">返回</a>

        <form autocomplete="off" onsubmit="event.preventDefault(); checkPassword();">
            <div style="margin-bottom: 16px;">
                <label for="username" class="bt"> 昵 称 </label>
                <input type="text" id="username" name="username" maxlength="11" placeholder="输入账号ID" autocomplete="off"
                    required>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="password" class="bt">原 密 码</label>
                <input type="password" id="old_password" name="old_password" placeholder="输入密码" autocomplete="off"
                    required>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="new_password" class="bt">新 密 码</label>
                <input type="password" id="new_password" name="new_password" placeholder="输入新密码" autocomplete="off"
                    required>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="confirm_password" class="bt">确认新密码</label>
                <input type="password" id="password" name="password" placeholder="再次输入新密码" autocomplete="off" required>
            </div>

            <div id="verificationCodeContainer" style="margin-bottom: 20px; display: none;">
                <label for="verificationCode" class="bt">注册验证码</label>
                <input type="password" id="verificationCode" name="verificationCode" minlength="29" maxlength="29"
                    placeholder="XXXXX-XXXXX-XXXXX-XXXXX-XXXXX" autocomplete="off" required>
            </div>

            <div id="errorMsg" style="color: #a4262c; margin-bottom: 16px; display: none;"></div>

            <button onclick="checkPassword()" id="submit" style="width: 100%;">提交申请</button>
        </form>

        <div style="text-align: center; margin-top: 16px;">
            <a href=".\register" id="register" style="color: #0078d4; text-decoration: none;">没有账号？点这里注册！</a>
        </div>
    </div>
    <br>
    <div id="errorMsg" style="color: red; display: none;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            toggleVerificationCode();
        });

        function toggleVerificationCode() {
            const accountType = document.getElementById('accountType').value;
            const verificationCodeContainer = document.getElementById('verificationCodeContainer');

            if (accountType === 'vip用户') {
                verificationCodeContainer.style.display = 'block';
                setTimeout(() => {
                    verificationCodeContainer.classList.add('show');
                }, 10);
            } else {
                verificationCodeContainer.classList.remove('show');
                setTimeout(() => {
                    verificationCodeContainer.style.display = 'none';
                }, 1000);
            }
        }

        // 添加自动识别用户类型功能
        document.getElementById('username').addEventListener('blur', function () {
            const username = this.value.trim();
            if (username) {
                fetch('user.txt')
                    .then(response => response.text())
                    .then(text => {
                        const lines = text.split('\n');
                        // 查找包含该用户名的行
                        const matchedLine = lines.find(line => {
                            const parts = line.split('-');
                            return parts.length >= 2 && parts[1] === username;
                        });

                        if (matchedLine) {
                            const parts = matchedLine.split('-');
                            const userType = parts[0]; // ZC 或 UR
                            const accountTypeSelect = document.getElementById('accountType');

                            // 根据用户类型自动设置选择框
                            if (userType === 'ZC') {
                                accountTypeSelect.value = 'vip用户';
                            } else if (userType === 'UR') {
                                accountTypeSelect.value = '普通用户';
                            }

                            // 自动切换验证码显示状态
                            toggleVerificationCode();

                            // 显示提示信息
                            if (!document.getElementById('autoDetectMsg')) {
                                const msg = document.createElement('div');
                                msg.id = 'autoDetectMsg';
                                msg.style.color = '#0078d4';
                                msg.style.fontSize = '12px';
                                msg.style.marginTop = '5px';
                                msg.textContent = `已自动识别为${userType === 'ZC' ? 'VIP' : '普通'}用户`;
                                accountTypeSelect.parentNode.appendChild(msg);
                            } else {
                                document.getElementById('autoDetectMsg').textContent =
                                    `已自动识别为${userType === 'ZC' ? 'VIP' : '普通'}用户`;
                            }
                        } else {
                            // 用户不存在，清除提示
                            const existingMsg = document.getElementById('autoDetectMsg');
                            if (existingMsg) {
                                existingMsg.remove();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('读取用户数据失败:', error);
                    });
            } else {
                // 用户名为空，清除提示
                const existingMsg = document.getElementById('autoDetectMsg');
                if (existingMsg) {
                    existingMsg.remove();
                }
            }
        });
    </script>

    <style>
        #verificationCodeContainer {
            margin-bottom: 20px;
            display: none;
            opacity: 0;
            transition: opacity 1s ease, height 1s ease;
            height: 0;
            overflow: hidden;
        }

        #verificationCodeContainer.show {
            opacity: 1;
            height: auto;
        }

        .bt {
            font-weight: 600;
            color: #323130;
            font-size: 14px;
            margin-bottom: 4px;
            display: inline-block;
            width: 0;
            transition: width 1s ease;
            overflow: hidden;
            white-space: nowrap;
        }

        .bt.show {
            width: auto;
        }

        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #106ebe;
        }

        button:active {
            background-color: #005a9e;
        }

        h1 {
            display: block !important;
            width: auto !important;
            opacity: 1 !important;
        }

        .bt {
            font-weight: 600;
            color: #323130;
            font-size: 14px;
            margin-bottom: 4px;
            display: inline-block;
            width: auto;
            transition: none;
            overflow: visible;
            white-space: normal;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // 全局变量记录许可证错误次数
        let licenseErrorCount = 0;
        let isLocked = false;
        let originalElements = {
            upback: null,
            submit: null,
            register: null
        };

        function checkPassword() {
            // 如果处于锁定状态，直接返回
            if (isLocked) {
                return;
            }

            const username = document.getElementById('username').value;
            const old_password_input = document.getElementById('old_password').value;
            const new_password_input = document.getElementById('new_password').value;
            const confirm_password_input = document.getElementById('password').value;
            const verificationCode = document.getElementById('verificationCode')?.value;
            const errorMsg = document.getElementById('errorMsg');

            errorMsg.style.display = 'none';

            // 输入验证：检查所有必填字段是否为空
            if (!username.trim()) {
                errorMsg.textContent = '用户名不能为空';
                errorMsg.style.display = 'block';
                return;
            }

            if (!old_password_input.trim()) {
                errorMsg.textContent = '原密码不能为空';
                errorMsg.style.display = 'block';
                return;
            }

            if (!new_password_input.trim()) {
                errorMsg.textContent = '新密码不能为空';
                errorMsg.style.display = 'block';
                return;
            }

            if (!confirm_password_input.trim()) {
                errorMsg.textContent = '确认密码不能为空';
                errorMsg.style.display = 'block';
                return;
            }

            // 检查新密码和确认密码是否一致
            if (new_password_input !== confirm_password_input) {
                errorMsg.textContent = '新密码验证失败';
                errorMsg.style.display = 'block';
                return;
            }

            // 检查新密码是否与原密码相同
            if (new_password_input === old_password_input) {
                errorMsg.textContent = '新密码不能与原密码相同';
                errorMsg.style.display = 'block';
                return;
            }

            // 对密码进行MD5加密
            const old_password = CryptoJS.MD5(old_password_input).toString(CryptoJS.enc.Base64);
            const new_password = CryptoJS.MD5(new_password_input).toString(CryptoJS.enc.Base64);
            const confirm_password = CryptoJS.MD5(confirm_password_input).toString(CryptoJS.enc.Base64);

            // 自动识别用户类型
            fetch('./user.txt')
                .then(response => response.text())
                .then(text => {
                    const lines = text.split('\n');
                    // 查找包含该用户名的行
                    const matchedLine = lines.find(line => {
                        const parts = line.split('-');
                        return parts.length >= 2 && parts[1] === username;
                    });

                    if (matchedLine) {
                        const parts = matchedLine.split('-');
                        const userType = parts[0]; // ZC 或 UR
                        const authToken = `${userType}-${username}-${old_password}`;

                        // 检查原密码是否正确
                        if (text.includes(authToken)) {
                            if (userType === 'ZC') {
                                // VIP用户需要验证许可码
                                fetch('./key.txt')
                                    .then(response => {
                                        if (!response.ok) throw new Error('读取许可码失败');
                                        return response.text();
                                    })
                                    .then(keyContent => {
                                        // 读取所有许可码到数组中，并去除每行的空白字符
                                        const validLicenses = keyContent.split('\n')
                                            .map(license => license.trim())
                                            .filter(license => license.length > 0);

                                        // 验证许可码是否存在于key.txt中
                                        if (!validLicenses.includes(verificationCode)) {
                                            licenseErrorCount++;
                                            errorMsg.textContent = `验证码错误，请检查许可码是否正确（错误次数：${licenseErrorCount}/3）`;
                                            errorMsg.style.display = 'block';

                                            // 如果错误次数达到3次，锁定页面
                                            if (licenseErrorCount >= 3) {
                                                lockPage();
                                            }
                                            return;
                                        }

                                        // 验证成功，重置错误计数
                                        licenseErrorCount = 0;
                                        proceedWithPasswordChange(userType, username, new_password, authToken);
                                    })
                                    .catch(error => {
                                        console.error('读取许可码文件出错:', error);
                                        errorMsg.textContent = '系统错误，无法验证许可码';
                                        errorMsg.style.display = 'block';
                                    });
                            } else {
                                // 普通用户直接进行密码修改
                                proceedWithPasswordChange(userType, username, new_password, authToken);
                            }
                        } else {
                            errorMsg.textContent = '原密码错误';
                            errorMsg.style.display = 'block';
                        }
                    } else {
                        errorMsg.textContent = '用户名不存在';
                        errorMsg.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('读取文件出错:', error);
                    errorMsg.textContent = '系统错误，请稍后再试';
                    errorMsg.style.display = 'block';
                });
        }

        function lockPage() {
            isLocked = true;

            // 保存原始元素
            originalElements.upback = document.getElementById('upback');
            originalElements.submit = document.getElementById('submit');
            originalElements.register = document.getElementById('register');

            // 删除元素
            if (originalElements.upback) originalElements.upback.remove();
            if (originalElements.submit) originalElements.submit.remove();
            if (originalElements.register) originalElements.register.remove();

            // 创建错误提示
            const errorDiv = document.createElement('div');
            errorDiv.id = 'licenseError';
            errorDiv.style.color = 'red';
            errorDiv.style.fontWeight = 'bold';
            errorDiv.style.textAlign = 'center';
            errorDiv.style.marginTop = '20px';
            errorDiv.style.padding = '15px';
            errorDiv.style.backgroundColor = '#ffe6e6';
            errorDiv.style.border = '2px solid red';
            errorDiv.style.borderRadius = '8px';
            errorDiv.innerHTML = '许可证验证错误次数过多，页面已锁定，请等待30秒后重试';

            // 插入到注册链接原来的位置
            const registerContainer = document.querySelector('div[style*="text-align: center"]');
            if (registerContainer) {
                registerContainer.appendChild(errorDiv);
            }

            // 30秒后恢复页面
            setTimeout(() => {
                restorePage();
            }, 30000);
        }

        function restorePage() {
            isLocked = false;
            licenseErrorCount = 0;

            // 移除错误提示
            const errorDiv = document.getElementById('licenseError');
            if (errorDiv) errorDiv.remove();

            // 恢复原始元素
            const registerContainer = document.querySelector('div[style*="text-align: center"]');
            if (registerContainer) {
                if (originalElements.upback) {
                    const formContainer = document.querySelector('div[style*="max-width: 500px"]');
                    if (formContainer) {
                        const h1 = formContainer.querySelector('h1');
                        if (h1) {
                            h1.insertAdjacentElement('afterend', originalElements.upback);
                        }
                    }
                }

                if (originalElements.submit) {
                    const form = document.querySelector('form');
                    if (form) {
                        const errorMsg = form.querySelector('#errorMsg');
                        if (errorMsg) {
                            errorMsg.insertAdjacentElement('afterend', originalElements.submit);
                        }
                    }
                }

                if (originalElements.register) {
                    registerContainer.appendChild(originalElements.register);
                }
            }
        }

        function proceedWithPasswordChange(typeCode, username, new_password, old_user) {
            const user = `${typeCode}-${username}-${new_password}`;

            fetch('./upk.txt')
                .then(response => response.text())
                .then(upk => {
                    const now = new Date();
                    const timeStr = now.toISOString().replace(/T/, ' ').replace(/\..+/, '');

                    const message = `请将${old_user}/${upk}\\${user}'${timeStr}用短信发送到13258227085`;

                    const msgDiv = document.createElement('div');
                    msgDiv.style.position = 'fixed';
                    msgDiv.style.top = '50%';
                    msgDiv.style.left = '50%';
                    msgDiv.style.transform = 'translate(-50%, -50%)';
                    msgDiv.style.backgroundColor = 'white';
                    msgDiv.style.padding = '20px';
                    msgDiv.style.borderRadius = '8px';
                    msgDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    msgDiv.style.zIndex = '1000';
                    msgDiv.style.textAlign = 'center';

                    const msgText = document.createElement('p');
                    msgText.textContent = message;
                    msgDiv.appendChild(msgText);

                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = '已发送，回到主页';
                    confirmBtn.style.marginTop = '15px';
                    confirmBtn.onclick = function () {
                        window.location.href = '../';
                    };
                    msgDiv.appendChild(confirmBtn);

                    document.body.appendChild(msgDiv);
                })
                .catch(error => {
                    console.error('读取upk.txt失败:', error);
                    const errorMsg = document.getElementById('errorMsg');
                    errorMsg.textContent = '系统错误，无法生成修改请求';
                    errorMsg.style.display = 'block';
                });
        }

        // 修改自动识别用户类型功能，移除对accountType的引用
        document.getElementById('username').addEventListener('blur', function () {
            const username = this.value.trim();
            if (username) {
                fetch('user.txt')
                    .then(response => response.text())
                    .then(text => {
                        const lines = text.split('\n');
                        // 查找包含该用户名的行
                        const matchedLine = lines.find(line => {
                            const parts = line.split('-');
                            return parts.length >= 2 && parts[1] === username;
                        });

                        if (matchedLine) {
                            const parts = matchedLine.split('-');
                            const userType = parts[0]; // ZC 或 UR
                            const verificationCodeContainer = document.getElementById('verificationCodeContainer');

                            // 根据用户类型自动切换验证码显示状态
                            if (userType === 'ZC') {
                                verificationCodeContainer.style.display = 'block';
                                setTimeout(() => {
                                    verificationCodeContainer.classList.add('show');
                                }, 10);
                            } else {
                                verificationCodeContainer.classList.remove('show');
                                setTimeout(() => {
                                    verificationCodeContainer.style.display = 'none';
                                }, 1000);
                            }

                            // 显示提示信息
                            if (!document.getElementById('autoDetectMsg')) {
                                const msg = document.createElement('div');
                                msg.id = 'autoDetectMsg';
                                msg.style.color = '#0078d4';
                                msg.style.fontSize = '12px';
                                msg.style.marginTop = '5px';
                                msg.textContent = `已自动识别为${userType === 'ZC' ? 'VIP' : '普通'}用户`;
                                document.getElementById('username').parentNode.appendChild(msg);
                            } else {
                                document.getElementById('autoDetectMsg').textContent =
                                    `已自动识别为${userType === 'ZC' ? 'VIP' : '普通'}用户`;
                            }
                        } else {
                            // 用户不存在，清除提示
                            const existingMsg = document.getElementById('autoDetectMsg');
                            if (existingMsg) {
                                existingMsg.remove();
                            }
                            // 隐藏验证码输入框
                            const verificationCodeContainer = document.getElementById('verificationCodeContainer');
                            verificationCodeContainer.classList.remove('show');
                            setTimeout(() => {
                                verificationCodeContainer.style.display = 'none';
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('读取用户数据失败:', error);
                    });
            } else {
                // 用户名为空，清除提示
                const existingMsg = document.getElementById('autoDetectMsg');
                if (existingMsg) {
                    existingMsg.remove();
                }
                // 隐藏验证码输入框
                const verificationCodeContainer = document.getElementById('verificationCodeContainer');
                verificationCodeContainer.classList.remove('show');
                setTimeout(() => {
                    verificationCodeContainer.style.display = 'none';
                }, 1000);
            }
        });
    </script>
</body>


</html>

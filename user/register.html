<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>注册只因科技账号(中国)</title>
    <link rel="icon" href="ziyit.png" type="image/x-icon">
    <style>
        body {
            background-color: skyblue;
        }

        nav {
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }

        .product-grid {
            display: flex;
            flex-wrap: wrap;
        }

        .product {
            margin: 10px;
        }

        .brg {
            text-align: left;
        }


        a {
            text-decoration: none;
            color: forestgreen;
        }

        /*  文本装饰         下划线    上划线   中划线       取消文本装饰的线
        text-decoration: underline,overline,line-througt,none;*/

        /*伪类语法：🖱放上发生颜色改变*/
        a:hover {
            text-decoration: underline overline;
            color: chartreuse;
        }

        #help {
            cursor: help;
        }

        a {
            text-decoration: none;
            color: #000000;
        }

        #previous:active {
            cursor: wait;
        }

        .brg {
            cursor: crosshair;
        }

        .bt {
            cursor: default;
        }

        #Navigation {
            width: 1282px;
            height: 134px;
            background: url(ziyit_miv.png);
            margin: 10px auto;
        }
    </style>
</head>

<body>
    <div id="Navigation">
        <a href="..\download\index.html" class="brg">
            <img src="download.png" alt="下载" class="brg">
        </a>
        <a href="..\index.html" class="brg">
            <img src="index.png" alt="主页" class="brg">
        </a>
        <a href="..\move\index.html" id="help">
            <img src="help.png" alt="帮助">
        </a>
        <a href="index.html" id="previous" class="brg">
            <img src="previous.png" width="332" height="134" alt="上一步">
        </a>
    </div>
    <hr class="brg">
    <h1 id="up" class="bt">注册只因科技</h1>
    <form id="registerForm" method="post" action="register.php">
        请选择账号类型:
        <select id="accountType" name="accountType" onchange="toggleLicense()">
            <option value="用户">用户</option>
            <option value="ziyit工作人员">ziyit工作人员</option>
        </select>
        <br>
        <label for="username" class="bt">请输入11位手机号: </label>
        <input type="text" id="username" name="username" maxlength="11" required>
        <br>
        <label for="password" class="bt">密码: </label>
        <input type="password" id="password" name="password" required>
        <br>
        <div id="licenseDiv" style="display:none;">
            <label for="license" class="bt">操作许可码: </label>
            <input type="text" id="license" name="license" placeholder="XXXXX-XXXXX-XXXXX-XXXXX-XXXXX">
        </div>
        <br>
        <button type="submit">注册</button>
    </form>

    <script>
        function toggleLicense() {
            const accountType = document.getElementById('accountType').value;
            const licenseDiv = document.getElementById('licenseDiv');
            licenseDiv.style.display = accountType === 'ziyit工作人员' ? 'block' : 'none';
            if (accountType !== 'ziyit工作人员') {
                document.getElementById('license').value = '';
            }
        }

        // 阻止表单默认提交行为
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            checkLogin();
        });

        // 添加全局变量存储许可码
        let validLicense = "";

        // 修改读取key.txt的方式
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('https://ziyit-hacker.github.io/tas/user/key.txt');
                if (!response.ok) throw new Error('读取许可码失败');
                const keyContent = await response.text();
                validLicense = keyContent.split('\n')[0].trim();
            } catch (e) {
                console.error('初始化错误:', e);
                alert('系统初始化错误: ' + e.message);
            }
        });

        async function saveUserData(data, type) {
            try {
                // 替换为你的GitHub Token（注意：前端暴露Token不安全，仅演示用）
                const token = '你的GitHub_Token';
                const repo = 'ziyit-hacker/tas';
                const path = 'user/user.txt';
                
                // 1. 获取文件当前内容
                const getResponse = await fetch(
                    `https://api.github.com/repos/${repo}/contents/${path}`,
                    {
                        headers: { 'Authorization': `token ${token}` }
                    }
                );
                
                const fileData = await getResponse.json();
                const currentContent = atob(fileData.content.replace(/\n/g, ''));
                
                // 2. 更新文件内容
                const updateResponse = await fetch(
                    `https://api.github.com/repos/${repo}/contents/${path}`,
                    {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: '更新用户数据',
                            content: btoa(currentContent + data + '\n'),
                            sha: fileData.sha
                        })
                    }
                );
        
                if (!updateResponse.ok) throw new Error('更新失败');
                
                alert('注册成功！');
                window.location.href = './index.html';
                return true;
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败: ' + error.message);
                return false;
            }
        }

        function checkLogin() {
            const accountType = document.getElementById('accountType').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (accountType === 'ziyit工作人员') {
                const license = document.getElementById('license').value;
                const licensePattern = /^[0-9A-Fa-f]{5}(?:-[0-9A-Fa-f]{5}){4}$/;

                if (!licensePattern.test(license)) {
                    alert('许可码格式不正确！');
                    return;
                }

                // 验证许可码（从key.txt读取）
                if (!validLicense || license !== validLicense) {
                    alert('许可码不正确或系统未加载许可码！');
                    window.location.href = '../index.html';
                    return;
                }

                // 修改保存方式，添加类型前缀
                if(!saveUserData(`ZC-${username}-${password}`, 'staff')) {
                    return;
                }
                // 移除重复的alert
                // alert('注册成功！');  // 这行可以删除
            } else {
                // 修改检查逻辑，只检查普通用户
                const users = JSON.parse(localStorage.getItem('normalUsers') || '[]');
                if (users.some(user => user.includes(`-${username}-`))) {
                    alert('用户已存在！');
                    window.location.href = '../index.html';
                    return;
                }

                if(!saveUserData(`UR-${username}-${password}`, 'normal')) {
                    return;
                }
                // 移除重复的alert
                // alert('注册成功！');  // 这行可以删除
            }
        }
    </script>
    <a href="#up" class="brg">
        <img src="up.png" alt="到顶部">
    </a>
</body>

</html>
